# Risk Assessment - Story 5.1: User Account Management Interface

**Assessment Date:** 2025-10-29  
**Assessed By:** Quinn (Test Architect)  
**Story Status:** Ready for Review → Changes Required  
**Overall Risk Level:** MEDIUM-HIGH

---

## Executive Summary

Story 5.1 implements core user account management functionality with solid architecture and proper separation of concerns. However, a critical security gap (missing RLS policies) and incomplete test coverage elevate the overall risk to MEDIUM-HIGH. The functionality works correctly, but security relies solely on application-level checks rather than defense-in-depth.

**Key Recommendation:** Address RLS policy gap and complete integration tests before production deployment.

---

## Risk Matrix

| Risk ID  | Category    | Description                                       | Probability   | Impact        | Score | Mitigation                          |
| -------- | ----------- | ------------------------------------------------- | ------------- | ------------- | ----- | ----------------------------------- |
| SEC-001  | Security    | Missing RLS INSERT/UPDATE policies on users table | High (8/10)   | Medium (7/10) | 7.0   | Create migration with RLS policies  |
| SEC-002  | Security    | Password complexity not enforced                  | Medium (5/10) | Low (4/10)    | 2.5   | Add regex validation for complexity |
| TEST-001 | Quality     | Missing integration tests for API routes          | High (9/10)   | Medium (6/10) | 6.8   | Complete Task 8                     |
| TEST-002 | Quality     | Missing component tests                           | Medium (7/10) | Medium (5/10) | 4.4   | Complete Task 10                    |
| PERF-001 | Performance | No pagination for user list                       | Low (2/10)    | Low (3/10)    | 0.8   | Defer until user count >1000        |

**Risk Score Calculation:** Probability × Impact / 10 (normalized to 0-10 scale)

---

## Detailed Risk Analysis

### SEC-001: Missing RLS Policies (HIGH RISK - Score 7.0)

**Description:**  
The database migration creates the `users` table with RLS enabled, but only defines SELECT policies. There are no INSERT or UPDATE policies for HR Admin. This means the API routes must use service role credentials to bypass RLS.

**Current State:**

```sql
-- Only these policies exist:
CREATE POLICY "Users can read their own record" ON public.users
  FOR SELECT USING (auth_user_id = auth.uid());

CREATE POLICY "HR Admin can read all users" ON public.users
  FOR SELECT USING (get_user_role() = 'hr_admin');
```

**Missing Policies:**

```sql
CREATE POLICY "HR Admin can insert users" ON public.users
  FOR INSERT WITH CHECK (get_user_role() = 'hr_admin');

CREATE POLICY "HR Admin can update users" ON public.users
  FOR UPDATE USING (get_user_role() = 'hr_admin');
```

**Impact Analysis:**

- Application-level auth (`requireHRAdminAPI()`) is the only protection
- If application layer is bypassed (e.g., direct database access, SQL injection), unauthorized modifications possible
- Violates defense-in-depth security principle from architecture/security-and-performance.md
- RLS is PRIMARY security enforcement per coding standards, API checks are SECONDARY

**Probability:** High (8/10)

- This is a common oversight in rapid development
- Database access patterns may change in future features
- Service role credentials present in environment variables

**Impact:** Medium (7/10)

- Could allow unauthorized user creation/modification if app layer compromised
- Does not expose employee PII directly
- Requires authenticated access to database (not public exploit)

**Mitigation Plan:**

1. Create migration `20251029000000_add_user_rls_policies.sql`
2. Add INSERT policy with `WITH CHECK (get_user_role() = 'hr_admin')`
3. Add UPDATE policy with `USING (get_user_role() = 'hr_admin')`
4. Test API routes still function correctly (should be transparent)
5. Verify non-admin users cannot manipulate users table via direct queries

**Estimated Effort:** 30 minutes  
**Priority:** P0 - Blocking Production

---

### TEST-001: Missing Integration Tests (MEDIUM-HIGH RISK - Score 6.8)

**Description:**  
Integration tests for API routes (Task 8) are not implemented. Only service layer unit tests exist.

**Impact Analysis:**

- No automated validation of API authentication/authorization flows
- Cannot verify HTTP status codes (401, 403, 404, 409, 500) without manual testing
- Regression risks when auth patterns change
- Cannot verify Supabase integration (auth user creation, session revocation)

**Probability:** High (9/10)

- Incomplete test coverage is a known gap (Task 8 explicitly marked incomplete)
- Complex auth flows are prone to regressions

**Impact:** Medium (6/10)

- Security bugs could go undetected
- Breaking changes may reach production
- Manual testing burden increases

**Mitigation Plan:**

1. Implement `tests/integration/api/admin-users.test.ts`
2. Cover scenarios:
   - GET /api/admin/users returns 200 for hr_admin
   - GET /api/admin/users returns 403 for non-admin
   - POST /api/admin/users creates user (201)
   - POST validates email format (400)
   - POST prevents duplicate emails (409)
   - PATCH deactivates user (200)
   - PATCH prevents self-deactivation (403)
   - PATCH returns 404 for non-existent user
3. Run tests in CI/CD pipeline

**Estimated Effort:** 2-3 hours  
**Priority:** P1 - Required for Quality Confidence

---

### TEST-002: Missing Component Tests (MEDIUM RISK - Score 4.4)

**Description:**  
Component tests for UI (Task 10) are not implemented. Only service layer has coverage.

**Impact Analysis:**

- Form validation cannot be regression-tested
- User interactions (activate/deactivate, modal flows) not verified
- Error display and loading states not covered

**Probability:** Medium (7/10)

- UI bugs are common in rapid development
- Form validation logic can break with dependency updates

**Impact:** Medium (5/10)

- UX bugs may reach production
- Validation bypass possible if client-side validation breaks
- Accessibility regressions not caught

**Mitigation Plan:**

1. Implement `tests/unit/components/user-management-table.test.tsx`
2. Implement `tests/unit/components/add-user-modal.test.tsx`
3. Cover scenarios:
   - Email format validation
   - Password length validation
   - Role dropdown functionality
   - Activate/deactivate button logic
   - Confirmation dialog flow
   - Current user's deactivate button disabled

**Estimated Effort:** 2-3 hours  
**Priority:** P1 - Required for Regression Protection

---

### SEC-002: Password Complexity Not Enforced (LOW-MEDIUM RISK - Score 2.5)

**Description:**  
Password validation only enforces 8-character minimum. No complexity requirements (uppercase, lowercase, numbers, symbols).

**Impact Analysis:**

- Users could create weak passwords like "password123"
- Increased brute-force attack vulnerability
- Does not meet common security standards (NIST, OWASP)

**Probability:** Medium (5/10)

- HR Admins may choose simple passwords for convenience
- No enforcement mechanism currently

**Impact:** Low (4/10)

- Only affects admin accounts (not employee PII access)
- Mitigated by other factors (rate limiting, session management)
- Low probability of targeted attacks on HR system

**Mitigation Plan:**

1. Update `createUserSchema` in `user-validation.ts`:

```typescript
password: z.string()
  .min(8, 'Password must be at least 8 characters')
  .regex(/[A-Z]/, 'Password must contain uppercase letter')
  .regex(/[a-z]/, 'Password must contain lowercase letter')
  .regex(/[0-9]/, 'Password must contain number')
  .regex(/[^A-Za-z0-9]/, 'Password must contain special character');
```

2. Update AddUserModal to display complexity requirements
3. Test existing users are not affected (validation only on creation)

**Estimated Effort:** 1 hour  
**Priority:** P2 - Security Enhancement (non-blocking)

---

## Risk Mitigation Timeline

### Phase 1: Critical (Before Production) - 6-8 hours total

1. ✗ Create RLS policies migration (30 min)
2. ✗ Implement integration tests (2-3 hours)
3. ✗ Implement component tests (2-3 hours)
4. ✗ Manual testing validation (1 hour)

### Phase 2: Enhancements (Next Sprint) - 3-4 hours total

5. ⚠️ Add password complexity validation (1 hour)
6. ⚠️ Add JSDoc comments (1 hour)
7. ⚠️ Create manual testing documentation (1 hour)
8. ⚠️ Implement email password delivery (defer to production requirement)

---

## Acceptance Criteria Risk Coverage

| AC # | Description                  | Implementation Risk | Test Coverage Risk            | Overall Risk |
| ---- | ---------------------------- | ------------------- | ----------------------------- | ------------ |
| 1    | Navigation link              | LOW                 | MEDIUM (needs manual test)    | LOW          |
| 2    | User table display           | LOW                 | MEDIUM (needs component test) | LOW          |
| 3    | Add User modal               | LOW                 | MEDIUM (needs component test) | MEDIUM       |
| 4    | POST creates user            | MEDIUM (RLS gap)    | HIGH (no integration test)    | HIGH         |
| 5    | Success message              | LOW                 | MEDIUM (needs component test) | LOW          |
| 6    | Activate/deactivate          | LOW                 | MEDIUM (needs component test) | MEDIUM       |
| 7    | Deactivate revokes session   | MEDIUM              | HIGH (no integration test)    | MEDIUM       |
| 8    | Activate allows login        | LOW                 | HIGH (no integration test)    | MEDIUM       |
| 9    | Self-deactivation prevention | LOW                 | HIGH (no integration test)    | MEDIUM       |
| 10   | Testability                  | N/A                 | HIGH (incomplete tests)       | HIGH         |
| 11   | Validation errors            | LOW                 | MEDIUM (needs component test) | LOW          |

**High Risk ACs:** 4, 10  
**Medium Risk ACs:** 3, 6, 7, 8, 9  
**Low Risk ACs:** 1, 2, 5, 11

---

## Recommended Actions

### Immediate (P0 - Blocking Production)

1. **Create RLS policies migration** - Addresses SEC-001 (highest risk)
2. **Implement integration tests** - Addresses TEST-001 and validates security

### High Priority (P1 - Before Production Sign-off)

3. **Implement component tests** - Addresses TEST-002
4. **Manual testing validation** - Verifies all ACs end-to-end

### Medium Priority (P2 - Next Sprint)

5. **Add password complexity** - Addresses SEC-002
6. **Complete documentation** - Supports future maintenance

---

## Sign-off

**Risk Assessment Approved By:** Quinn (Test Architect)  
**Date:** 2025-10-29  
**Gate Status:** CONCERNS (see gate file for full decision)

**Recommendation:** Address P0 and P1 items before production deployment. Story provides solid foundation but requires security and test coverage improvements.
