# Story 4.6: Change Notifications for External Party Views

## Status

**DRAFT**

---

## Story

**As an** external party user,  
**I want** to receive visual notifications when masterdata changes affect my current filtered/sorted view,  
**so that** I'm aware when employees enter, leave, or are updated in my view without manually refreshing.

---

## Acceptance Criteria

1. When HR Admin updates masterdata causing an employee to newly match the external party's active filter criteria (e.g., hire_date change moves employee into filtered date range), a toast notification appears: \"1 new employee matches your filters: [Employee Name]\"
2. When HR Admin updates masterdata causing an employee to no longer match the external party's active filter criteria, a toast notification appears: \"1 employee no longer matches your filters: [Employee Name]\"
3. When HR Admin updates a masterdata field for an employee already visible in the external party's view, a toast notification appears: \"Employee [Name] was updated ([Field] changed)\"
4. Notifications appear as non-intrusive toast messages in the bottom-right corner using Sonner library (already in project)
5. Notifications are dismissible by clicking the X icon or automatically dismiss after 5 seconds
6. If multiple employees are affected simultaneously (e.g., bulk import), notifications are batched: \"3 new employees match your filters\"
7. Clicking a notification focuses/scrolls to the affected employee row in the table (optional enhancement for MVP)
8. Notifications only trigger for changes affecting the user's current view state (if no filters active, only show \"Employee [Name] was updated\")
9. ViewStateTracker custom hook tracks current filter/sort state and visible employee IDs to determine notification triggers
10. Notifications do not trigger for the user's own edits to custom columns (only for HR masterdata changes)
11. Performance: Notification logic executes in <100ms after real-time event received
12. Accessibility: Notifications are announced to screen readers using ARIA live regions

---

## Tasks / Subtasks

- [ ] **Task 1: Create ViewStateTracker Hook** (AC: 9, 11)

  - [ ] Create src/lib/hooks/use-view-state-tracker.ts
  - [ ] Define ViewState interface: visibleEmployeeIds, activeFilters, activeSortColumn, activeSortDirection
  - [ ] Implement hook to track current table state (employees visible, filters, sort)
  - [ ] Update ViewState when filter/sort changes
  - [ ] Export hook for use in employee table component

- [ ] **Task 2: Implement Change Detection Logic** (AC: 1, 2, 3, 8)

  - [ ] Create function: detectViewImpact(oldEmployee, newEmployee, viewState): NotificationType | null
  - [ ] Logic for \"Employee Added to View\": employee wasn't in visibleEmployeeIds before, is now
  - [ ] Logic for \"Employee Removed from View\": employee was in visibleEmployeeIds before, isn't now
  - [ ] Logic for \"Employee Updated in View\": employee was and still is in visibleEmployeeIds
  - [ ] Handle edge case: No filters active only show \"Updated\" notifications
  - [ ] Unit test all detection logic branches

- [ ] **Task 3: Integrate with Real-Time Sync** (AC: 9, 10, 11)

  - [ ] Update src/components/dashboard/employee-table.tsx to use ViewStateTracker hook
  - [ ] On Supabase real-time UPDATE event, call detectViewImpact with old/new employee data
  - [ ] Pass current user role to prevent notifications for user's own custom column edits
  - [ ] Ensure notification logic executes before table re-render
  - [ ] Add performance timing to verify <100ms execution

- [ ] **Task 4: Implement Toast Notifications** (AC: 4, 5, 12)

  - [ ] Verify Sonner Toaster component exists in app layout (from Story 2.6)
  - [ ] Create notification helper: showChangeNotification(type, employeeName, details?)
  - [ ] Notification messages:
    - Added: \"1 new employee matches your filters: [Name]\"
    - Removed: \"1 employee no longer matches your filters: [Name]\"
    - Updated: \"Employee [Name] was updated ([Field] changed)\"
  - [ ] Configure toast duration: 5 seconds auto-dismiss
  - [ ] Add dismiss button (X icon)
  - [ ] Add ARIA live region for accessibility (Sonner default)

- [ ] **Task 5: Implement Batched Notifications** (AC: 6)

  - [ ] Create batching logic: If >1 employee affected simultaneously, batch notifications
  - [ ] Debounce notification triggers by 200ms to allow batching
  - [ ] Batch message: \"X new employees match your filters\" (no individual names)
  - [ ] Test with CSV import (Story 2.6) to verify batching works

- [ ] **Task 6: Optional Click-to-Focus Enhancement** (AC: 7)

  - [ ] Add onClick handler to notification toast
  - [ ] Implement scrollToRow function to focus/highlight affected employee row
  - [ ] Test click behavior (optional for MVP - can defer if time-constrained)

- [ ] **Task 7: Unit Tests for Change Detection** (AC: 1-3, 8)

  - [ ] Test: Employee enters view (filter match) \"Added\" notification
  - [ ] Test: Employee leaves view (filter no longer matches) \"Removed\" notification
  - [ ] Test: Employee updated in view \"Updated\" notification
  - [ ] Test: No active filters Only \"Updated\" notifications shown
  - [ ] Test: Change doesn't affect view No notification
  - [ ] Test: User's own custom column edit No notification (AC #10)

- [ ] **Task 8: Integration Tests for Real-Time Flow** (AC: 1-12)

  - [ ] Test: HR updates hire_date Employee enters external party's filtered view Notification appears
  - [ ] Test: HR archives employee Employee leaves view Notification appears
  - [ ] Test: HR updates name Employee in view \"Updated\" notification appears
  - [ ] Test: Multiple employees updated Batched notification appears
  - [ ] Test: Notification auto-dismisses after 5 seconds
  - [ ] Test: User can manually dismiss notification

- [ ] **Task 9: Performance Testing** (AC: 11)

  - [ ] Measure time from real-time event to notification logic completion
  - [ ] Verify <100ms execution time
  - [ ] Test with 1,000 employee dataset
  - [ ] Ensure no memory leaks from notification subscriptions

- [ ] **Task 10: Accessibility Testing** (AC: 12)

  - [ ] Verify ARIA live region announces notifications to screen readers
  - [ ] Test with screen reader (NVDA/JAWS/VoiceOver)
  - [ ] Ensure notification content is readable and clear
  - [ ] Verify dismiss button is keyboard-accessible (Tab + Enter)

- [ ] **Task 11: Manual User Flow Testing** (AC: 1-8)
  - [ ] Open 2 browsers: HR Admin + External Party (Sodexo)
  - [ ] External party applies filter: hire_date >= 2025-01-01
  - [ ] HR Admin updates employee hire_date: 2024-12-01 2025-01-15
  - [ ] Verify external party sees: \"1 new employee matches your filters: [Name]\"
  - [ ] Verify employee appears in table
  - [ ] HR Admin updates email of visible employee
  - [ ] Verify external party sees: \"Employee [Name] was updated (Email changed)\"
  - [ ] HR Admin imports 5 employees via CSV with hire_dates in 2025
  - [ ] Verify external party sees: \"5 new employees match your filters\"

---

## Dev Notes

### Previous Story Context

[Source: Story 4.5 Completion Notes - TO BE ADDED WHEN STORY 4.5 IS COMPLETE]

**Story 4.5 Will Establish:**

- Supabase real-time subscription to employees table
- Real-time change event handling in employee table component
- Visual highlight of updated rows (brief color pulse)
- Real-time sync performance (<2 seconds)

**Key Files Available After Story 4.5:**

- src/components/dashboard/employee-table.tsx - Real-time subscription logic
- src/lib/hooks/use-real-time-sync.ts (if created) - Real-time subscription hook
- Supabase real-time event handlers

### Architecture Context

[Source: architecture/frontend-architecture.md]

**Notification System:**

- **Library:** Sonner (already in project from Story 2.6)
- **Pattern:** Client-side change detection with ViewStateTracker hook
- **Implementation:** Compare real-time event data to current view state (filters, visible IDs)

**ViewStateTracker Hook Pattern:**

\\\ ypescript
// src/lib/hooks/use-view-state-tracker.ts
interface ViewState {
visibleEmployeeIds: Set<string>;
activeFilters: Record<string, any>;
activeSortColumn: string | null;
activeSortDirection: 'asc' | 'desc' | null;
}

export function useViewStateTracker(employees: Employee[], filters: any, sort: any) {
const [viewState, setViewState] = useState<ViewState>({
visibleEmployeeIds: new Set(employees.map(e => e.id)),
activeFilters: filters,
activeSortColumn: sort.column,
activeSortDirection: sort.direction,
});

useEffect(() => {
setViewState({
visibleEmployeeIds: new Set(employees.map(e => e.id)),
activeFilters: filters,
activeSortColumn: sort.column,
activeSortDirection: sort.direction,
});
}, [employees, filters, sort]);

return viewState;
}
\\\

**Change Detection Logic Pattern:**

\\\ ypescript
type NotificationType = 'added' | 'removed' | 'updated' | null;

function detectViewImpact(
oldEmployee: Employee | null,
newEmployee: Employee,
viewState: ViewState
): NotificationType {
const wasVisible = oldEmployee ? viewState.visibleEmployeeIds.has(oldEmployee.id) : false;
const isNowVisible = employeeMatchesFilters(newEmployee, viewState.activeFilters);

if (!wasVisible && isNowVisible) return 'added';
if (wasVisible && !isNowVisible) return 'removed';
if (wasVisible && isNowVisible) return 'updated';
return null;
}
\\\

[Source: architecture/tech-stack.md]

**Toast Notifications:** Sonner library (already in project)

- **Package:** sonner
- **Documentation:** https://sonner.emilkowal.ski/
- **Features:** Auto-dismiss, manual dismiss, ARIA live regions, customizable duration
- **Usage:** Import oast from 'sonner', call oast.info(\"Message\")

### Testing

[Source: architecture/testing-strategy.md]

**Testing Approach:**

**Unit Tests (70%):**

- detectViewImpact function: All notification type branches
- ViewStateTracker hook: State updates
- employeeMatchesFilters function: Filter matching logic

**Integration Tests (20%):**

- Real-time event notification flow
- Batched notifications
- Notification dismissal

**Manual Testing (10%):**

- User flow: HR updates External party sees notification
- Performance: <100ms, <2s appearance
- Accessibility: Screen reader announcements

**Test Coverage Goals:**

- ViewStateTracker hook: 90%+
- Change detection logic: 95%+
- Overall: 85%+

### Error Handling

**Error Scenarios:**

1. **Real-time Connection Dropped:** No notifications shown (fallback handled in Story 4.5)
2. **Notification Logic Error:** Log error to console, do not block table update
3. **Performance Degradation:** If >100ms, log warning

**No New API Calls Needed** - Notifications are client-side only.

### Performance Considerations

**Performance Requirements:**

- Notification logic: <100ms after real-time event (AC #11)
- No impact on table rendering
- Batching for bulk operations

**Optimization Techniques:**

- Debounce notification triggers (200ms) for batching
- Use Set data structure for visibleEmployeeIds (O(1) lookup)
- Memoize filter matching logic

---

## Change Log

| Date       | Version | Description                 | Author   |
| ---------- | ------- | --------------------------- | -------- |
| 2025-10-28 | 0.1     | Initial story draft created | PO Sarah |

---
