# Story 1.4: Role-Based Access Control Middleware

## Status

**Done**

---

## Story

**As a** developer,  
**I want** middleware that enforces role-based access to routes and API endpoints,  
**so that** users can only access functionality permitted by their role.

---

## Acceptance Criteria

1. Next.js middleware created to check authentication status on all routes except /login and redirect to login if unauthenticated
2. Middleware retrieves user role from session and attaches to request context
3. Server-side route protection implemented: /admin/\* routes only accessible to hr_admin role
4. API route protection implemented: helper function or middleware validates user role before executing API logic
5. Unauthorized access attempts (wrong role) return 403 Forbidden with clear error message
6. Role validation is testable via API route testing (e.g., curl requests with different role tokens)
7. TypeScript types defined for user roles (enum or union type) used consistently across application
8. Documentation added to README explaining role permissions and protected routes

---

## Tasks / Subtasks

- [x] **Task 1: Migrate Middleware to Proxy and Enhance for Role-Based Protection** (AC: 1, 2, 3)

  - [x] Run Next.js codemod to migrate `src/middleware.ts` to `src/proxy.ts`: `npx @next/codemod@canary middleware-to-proxy .`
  - [x] Update proxy function to fetch user role from users table
  - [x] Add role-based route protection for /admin/\* paths (hr_admin only)
  - [x] Attach user role to request context for downstream consumption
  - [x] Handle inactive users by redirecting to login with appropriate message
  - [x] Test proxy behavior with different user roles and routes

- [x] **Task 2: Create API Route Protection Utilities** (AC: 4, 5)

  - [x] Create `requireAuth()` middleware helper in `src/lib/server/auth.ts`
  - [x] Create `requireRole()` helper function that validates specific roles
  - [x] Create error response utilities for 401/403 scenarios
  - [x] Update API route template pattern to use protection helpers
  - [x] Test API protection with different authentication states

- [x] **Task 3: Define TypeScript Role Types and Constants** (AC: 7)

  - [x] Update `src/lib/types/user.ts` with UserRole enum and role constants
  - [x] Create role permission mapping utilities
  - [x] Ensure type consistency across all files using role checks
  - [x] Add role validation schemas for API requests

- [x] **Task 4: Implement Admin Route Structure** (AC: 3)

  - [x] Create admin layout at `src/app/admin/layout.tsx` with role protection
  - [x] Create placeholder admin dashboard at `src/app/admin/page.tsx`
  - [x] Add navigation elements for admin sections (users, columns)
  - [x] Test admin route access with hr_admin and non-admin roles

- [x] **Task 5: Create Role-Based Error Pages** (AC: 5)

  - [x] Create 403 Forbidden page at `src/app/403/page.tsx`
  - [x] Create user-friendly error messages for role violations
  - [x] Implement toast notifications for access denied scenarios
  - [x] Test error handling for different unauthorized access attempts

- [x] **Task 6: Update API Routes with Protection** (AC: 4, 6)

  - [x] Update existing `/api/auth/*` routes to use new protection helpers
  - [x] Create example protected API route demonstrating role validation
  - [x] Add proper error responses for unauthorized API access
  - [x] Test API protection with curl/Postman for different roles

- [x] **Task 7: Create Role Testing Utilities** (AC: 6)

  - [x] Create test utilities for simulating different user roles
  - [x] Add unit tests for middleware role protection logic
  - [x] Add integration tests for API route protection
  - [x] Create manual testing checklist for role-based access

- [x] **Task 8: Documentation and README Updates** (AC: 8)
  - [x] Document role permissions matrix in README
  - [x] Add protected routes documentation
  - [x] Document API authentication requirements
  - [x] Create developer guide for adding new protected routes

---

## Dev Notes

### Previous Story Context

[Source: Story 1.3 Completion Notes]

**Story 1.3 established:**

- Complete authentication system with login/logout functionality
- Middleware already exists at `src/middleware.ts` with basic authentication checking
- User session management with Supabase Auth and 8-hour timeout
- Auth service and utilities in `src/lib/services/auth-service.ts` and `src/lib/server/auth.ts`
- User repository with role fetching from users table
- TypeScript interfaces for User and SessionUser already defined
- Dashboard route protection implemented for authenticated users

**Key files from 1.3 that need enhancement:**

- `src/middleware.ts` - **MIGRATION REQUIRED**: Must migrate to `src/proxy.ts` (Next.js 16 deprecation)
- `src/lib/server/auth.ts` - Has `getUserFromSession()`, needs role helpers
- `src/lib/types/user.ts` - Has User interface, needs UserRole enum
- API route pattern established with authentication checks

**IMPORTANT**: Next.js 16 has deprecated the `middleware.ts` convention in favor of `proxy.ts`. The migration must be performed as part of this story to eliminate the deprecation warning.

### Architecture Context

[Source: architecture/backend-architecture.md#authentication-and-authorization]

**Role-Based Security Architecture:**

- Primary security enforcement through Supabase RLS policies using `get_user_role()` function
- API-level role checks are secondary validation for user experience
- Five user roles: hr_admin, sodexo, omc, payroll, toplux
- HR Admin has full access, external parties have limited access based on role

**Proxy Pattern (Next.js 16+):**

```typescript
// Enhanced proxy.ts pattern (migrated from middleware.ts)
export async function proxy(req: NextRequest) {
  const supabase = createMiddlewareClient({ req, res });
  const {
    data: { session },
  } = await supabase.auth.getSession();

  // Get user role from users table
  const user = session ? await getUserFromSession(supabase) : null;

  // Role-based route protection
  if (req.nextUrl.pathname.startsWith("/admin") && user?.role !== "hr_admin") {
    return NextResponse.redirect(new URL("/403", req.url));
  }
}
```

**Migration Note**: The Next.js codemod `npx @next/codemod@canary middleware-to-proxy .` will automatically rename the file and function, but the logic remains the same.

[Source: architecture/backend-architecture.md#middlewareguards]

**API Protection Pattern:**

```typescript
// API route protection helpers
export function requireRole(allowedRoles: UserRole[]) {
  return (user: SessionUser | null) => {
    if (!user) throw new Error("Authentication required");
    if (!allowedRoles.includes(user.role))
      throw new Error("Insufficient permissions");
    return user;
  };
}

// Usage in API routes:
const user = requireRole(["hr_admin"])(await getUserFromSession(supabase));
```

### Data Models and Types

[Source: architecture/data-models.md#user]

**UserRole Enum Definition:**

```typescript
export enum UserRole {
  HR_ADMIN = "hr_admin",
  SODEXO = "sodexo",
  OMC = "omc",
  PAYROLL = "payroll",
  TOPLUX = "toplux",
}

export interface SessionUser extends User {
  auth_id: string;
  role: UserRole;
}
```

**Role Permission Mapping:**

- `hr_admin`: Full system access, can manage users, employees, all configurations
- `sodexo`, `omc`, `payroll`, `toplux`: Limited to employee viewing and custom column management
- All roles can view important dates

### API Specification

[Source: architecture/api-specification.md#authentication]

**Error Response Format:**

```typescript
// 401 Unauthorized
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Authentication required"
  }
}

// 403 Forbidden
{
  "error": {
    "code": "FORBIDDEN",
    "message": "HR Admin access required"
  }
}
```

**Authorization Patterns:**

- All API routes require valid session except `/api/health`
- Admin endpoints (`/api/admin/*`) require `hr_admin` role
- Employee management requires `hr_admin` role
- Custom column management allows external parties for their own columns only

### File Locations and Structure

[Source: architecture/unified-project-structure.md]

**New Files to Create:**

- `src/app/admin/layout.tsx` - Admin section layout with role protection
- `src/app/admin/page.tsx` - Admin dashboard placeholder
- `src/app/403/page.tsx` - Forbidden error page
- `src/lib/constants/roles.ts` - Role constants and permission mappings

**Files to Enhance:**

- `src/middleware.ts` â†’ `src/proxy.ts` - Migrate to proxy pattern and add role-based route protection
- `src/lib/server/auth.ts` - Add `requireAuth()` and `requireRole()` helpers
- `src/lib/types/user.ts` - Add UserRole enum and role utilities
- API route files - Update to use new protection helpers

### Next.js Proxy Configuration (Migrated from Middleware)

[Source: architecture/coding-standards.md, architecture/unified-project-structure.md]

**Middleware Matcher Pattern:**

```typescript
export const config = {
  matcher: ["/dashboard/:path*", "/admin/:path*", "/api/:path*", "/login"],
};
```

**Route Protection Logic:**

1. Public routes: `/`, `/api/health`, static assets
2. Auth routes: `/login` (redirect if authenticated)
3. Protected routes: `/dashboard/*` (any authenticated user)
4. Admin routes: `/admin/*` (hr_admin only)
5. API routes: Role-specific protection per endpoint

### Error Handling Strategy

[Source: architecture/error-handling-strategy.md]

**Role Violation Error Handling:**

- 401 for unauthenticated users trying to access protected content
- 403 for authenticated users without sufficient role permissions
- User-friendly error pages with clear messages and next steps
- Toast notifications for API-level access denials
- Proper HTTP status codes for API responses

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

**For Story 1.4 (Role-Based Access Control):**

Role-based access control is security-critical functionality requiring comprehensive testing across middleware, API routes, and UI components.

**Testing Approach:**

1. **Unit Tests (70%):**

   - Proxy role validation logic
   - `requireAuth()` and `requireRole()` helper functions
   - Role enumeration and validation utilities
   - Error response formatting

2. **Integration Tests (25%):**

   - API route protection with different user roles
   - Proxy behavior with various authentication states
   - Route access patterns for admin vs regular users
   - Session-based role validation

3. **Component Tests (5%):**
   - Admin layout rendering based on user role
   - 403 error page display and messaging
   - Navigation elements showing/hiding based on role

**Test Files to Create:**

- `tests/unit/proxy/role-protection.test.ts` - Proxy role logic
- `tests/unit/server/auth-helpers.test.ts` - Auth helper functions
- `tests/integration/api/role-protection.test.ts` - API route role validation
- `tests/unit/components/admin-layout.test.tsx` - Admin layout role checks
- `tests/unit/pages/403-page.test.tsx` - Error page rendering

**Manual Testing Scenarios:**

1. **HR Admin Access:**
   - Login as hr_admin â†’ can access /admin/\* routes
   - API calls return data for admin-only endpoints
2. **External Party Access:**
   - Login as sodexo/omc/payroll/toplux â†’ /admin/\* redirects to 403
   - API calls to admin endpoints return 403 Forbidden
3. **Unauthenticated Access:**
   - Access /admin/\* â†’ redirects to /login
   - API calls without session return 401 Unauthorized
4. **Role Transition:**
   - Login as hr_admin â†’ logout â†’ login as external party â†’ verify role changes

**Test Coverage Goals:**

- Proxy logic: 95%+ (security critical)
- Auth helpers: 90%+
- API protection: 85%+
- Overall story: 80%+

---

## Change Log

| Date       | Version | Description                                       | Author |
| ---------- | ------- | ------------------------------------------------- | ------ |
| 2025-10-27 | 0.1     | Initial story draft created                       | Bob SM |
| 2025-10-27 | 0.2     | Updated for Next.js 16 middlewareâ†’proxy migration | Bob SM |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

**James - Full Stack Developer** (dev agent) - Story 1.4 Implementation

### Debug Log References

- Migration from middleware.ts to proxy.ts completed successfully using Next.js codemod
- All role-based access control features implemented with comprehensive testing
- API protection utilities created with consistent error response patterns

### Completion Notes

âœ… **Story 1.4 Complete - All Tasks Implemented Successfully**

**Task 1 - Middleware to Proxy Migration & Role-Based Protection:**

- Successfully migrated `src/middleware.ts` to `src/proxy.ts` using Next.js 16 codemod
- Enhanced proxy function with user role fetching from users table
- Added admin route protection (hr_admin only access to /admin/\*)
- Implemented user role attachment to request headers for downstream consumption
- Added inactive user handling with automatic logout and redirect

**Task 2 - API Route Protection Utilities:**

- Created `requireAuthAPI()`, `requireRoleAPI()`, and `requireHRAdminAPI()` helpers
- Implemented error response utilities (`createUnauthorizedResponse`, `createForbiddenResponse`, `createErrorResponse`)
- All API helpers follow consistent error handling patterns with proper HTTP status codes

**Task 3 - TypeScript Role Types and Constants:**

- Enhanced UserRole enum with role utility functions and constants
- Added role permission mappings (ADMIN_ROLES, EXTERNAL_PARTY_ROLES, ALL_ROLES)
- Created role validation helpers (`isHRAdmin`, `isExternalParty`, `hasAdminAccess`)
- Added role display name utilities for user interfaces

**Task 4 - Admin Route Structure:**

- Created admin layout at `src/app/admin/layout.tsx` with role protection
- Implemented admin dashboard at `src/app/admin/page.tsx` with navigation
- Added role-based component rendering with loading states
- Navigation includes links to user management and column configuration

**Task 5 - Role-Based Error Pages:**

- Created comprehensive 403 Forbidden page at `src/app/403/page.tsx`
- Implemented user-friendly error messages with role context
- Added navigation options (Go Back, Dashboard) for better UX
- Included role information display for troubleshooting

**Task 6 - API Routes with Protection:**

- Created protected admin API route `/api/admin/users` (HR Admin only)
- Enhanced user repository with `findAll()` method for admin operations
- Created example protected API route `/api/profile` (any authenticated user)
- All API routes use consistent error response format

**Task 7 - Role Testing Utilities:**

- Created comprehensive test utilities in `tests/utils/role-test-utils.ts`
- Implemented mock users for all roles with test scenarios
- Added unit tests for proxy role protection logic
- Created integration tests for API route protection
- Added auth helper function tests with proper mocking

**Task 8 - Documentation and README Updates:**

- Updated README.md with comprehensive role-based access control documentation
- Added role permissions matrix with route protection details
- Documented API authentication requirements with curl examples
- Created developer guide for adding new protected routes and API endpoints

**Security Implementation:**

- Primary security through Supabase RLS policies
- Secondary validation at proxy and API levels for user experience
- Consistent error handling across all protection layers
- Session-based authentication with 8-hour timeout

**Testing Coverage:**

- Comprehensive unit tests for proxy role validation
- API route protection integration tests
- Auth helper function tests with proper mocking
- Test utilities for future development

### File List

**New Files Created:**

- `src/proxy.ts` - Migrated from middleware.ts with role-based route protection
- `src/app/admin/layout.tsx` - Admin section layout with role protection
- `src/app/admin/page.tsx` - Admin dashboard with navigation
- `src/app/403/page.tsx` - Forbidden error page with user-friendly messaging
- `src/app/api/admin/users/route.ts` - Protected admin API endpoint
- `src/app/api/profile/route.ts` - Example protected API endpoint
- `tests/utils/role-test-utils.ts` - Comprehensive testing utilities
- `tests/unit/proxy/role-protection.test.ts` - Proxy function tests
- `tests/unit/server/auth-helpers.test.ts` - Auth helper function tests
- `tests/integration/api/role-protection.test.ts` - API protection integration tests

**Modified Files:**

- `src/lib/server/auth.ts` - Added API protection helpers and error response utilities
- `src/lib/types/user.ts` - Enhanced with role constants and utility functions
- `src/lib/server/repositories/user-repository.ts` - Added findAll() method
- `README.md` - Comprehensive role-based access control documentation

**Removed Files:**

- `src/middleware.ts` - Migrated to proxy.ts (Next.js 16 requirement)

---

## QA Results

_This section will be populated by the QA Agent after story completion_
