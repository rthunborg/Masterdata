# Story 5.11: SSN Field Auto-Formatting (Dashless Input)

## Status

**Approved**

---

## Story

**As an** HR Admin,  
**I want** to enter Swedish personal numbers without dashes and have the system auto-format them,  
**so that** data entry is faster and more flexible.

---

## Acceptance Criteria

1. SSN input field accepts both formats:
   - With dash: `YYMMDD-XXXX` (e.g., `850315-1234`)
   - Without dash: `YYMMDDXXXX` (e.g., `8503151234`)
2. Client-side validation accepts both formats as valid
3. On save (create or edit employee), backend normalizes SSN to standard format with dash (`YYMMDD-XXXX`)
4. Database stores SSN in normalized format
5. Display SSN in table with dash format
6. Update validation regex/Zod schema to accept 10-digit or 11-character (with dash) format
7. Test: Enter SSN without dash → saves successfully with dash added
8. Test: Enter SSN with dash → saves as-is

---

## Tasks / Subtasks

- [ ] **Update SSN Validation Schema** (AC: 1, 2, 6)
  - [ ] Open `src/lib/validation/employee-schema.ts`
  - [ ] Update `ssnRegex` to accept both formats: `/^\d{10}$|^\d{6,8}-\d{4}$/`
  - [ ] Test regex accepts `8503151234` (10 digits)
  - [ ] Test regex accepts `850315-1234` (6 digits + dash + 4 digits)
  - [ ] Test regex accepts `19850315-1234` (8 digits + dash + 4 digits)
  - [ ] Update error message to reflect new flexible format
  - [ ] Add JSDoc comment explaining both formats are accepted

- [ ] **Create SSN Normalization Utility Function** (AC: 3, 4)
  - [ ] Create `src/lib/utils/ssn-formatter.ts`
  - [ ] Implement `normalizeSSN(ssn: string): string` function
    - [ ] Strip all non-digit characters from input
    - [ ] If result is 10 digits: `YYMMDDXXXX` → insert dash at position 6 → `YYMMDD-XXXX`
    - [ ] If result is 12 digits: `YYYYMMDDXXXX` → extract last 10 digits → insert dash → `YYMMDD-XXXX`
    - [ ] Return normalized format `YYMMDD-XXXX`
  - [ ] Add error handling for invalid lengths (throw descriptive error)
  - [ ] Add JSDoc with examples
  - [ ] Export function for use in backend services

- [ ] **Update Backend Employee Service** (AC: 3, 4)
  - [ ] Open `src/lib/server/services/employee-service.ts`
  - [ ] Import `normalizeSSN` from `@/lib/utils/ssn-formatter`
  - [ ] In `createEmployee` method: Normalize SSN before database insert
  - [ ] In `updateEmployee` method: Normalize SSN if SSN field is being updated
  - [ ] Ensure normalization happens AFTER validation (validation accepts both formats)
  - [ ] Test: Create employee with `8503151234` → database stores `850315-1234`
  - [ ] Test: Update employee SSN from `850315-1234` to `9001011234` → database stores `900101-1234`

- [ ] **Update API Route for Employee Creation** (AC: 3)
  - [ ] Open `src/app/api/employees/route.ts` (POST handler)
  - [ ] Verify SSN normalization is called via service layer (already handled if service updated)
  - [ ] No direct changes needed if service layer handles normalization
  - [ ] Test API endpoint: POST with dashless SSN returns normalized SSN in response

- [ ] **Update API Route for Employee Update** (AC: 3)
  - [ ] Open `src/app/api/employees/[id]/route.ts` (PATCH handler)
  - [ ] Verify SSN normalization is called via service layer
  - [ ] No direct changes needed if service layer handles normalization
  - [ ] Test API endpoint: PATCH with dashless SSN returns normalized SSN in response

- [ ] **Update CSV Import Validation Schema** (AC: 1, 2, 6)
  - [ ] Open `src/lib/validation/employee-schema.ts`
  - [ ] Update `csvImportEmployeeSchema` SSN regex to match new flexible pattern
  - [ ] Test: CSV import with dashless SSNs validates successfully
  - [ ] Test: CSV import with dashed SSNs validates successfully
  - [ ] Ensure CSV import also normalizes SSN before database insert

- [ ] **Update Frontend Display** (AC: 5)
  - [ ] Verify Employee Table displays SSN from database (already in normalized format)
  - [ ] No changes needed to `src/components/dashboard/employee-table.tsx` (displays database value)
  - [ ] Verify Edit Employee Modal displays SSN from database (normalized format)
  - [ ] No changes needed to edit modal (displays database value)

- [ ] **Update Translation Files** (AC: 2, 6)
  - [ ] Open `messages/en.json`
  - [ ] Update SSN validation error message:
    ```json
    "validation": {
      "ssnFormat": "SSN must be in format YYMMDD-XXXX or YYMMDDXXXX (10 digits)"
    }
    ```
  - [ ] Open `messages/sv.json`
  - [ ] Update Swedish SSN validation error message:
    ```json
    "validation": {
      "ssnFormat": "Personnummer måste vara i format ÅÅMMDD-XXXX eller ÅÅMMDDXXXX (10 siffror)"
    }
    ```

- [ ] **Create Unit Tests for SSN Normalization** (AC: 3, 4, 7, 8)
  - [ ] Create `tests/unit/utils/ssn-formatter.test.ts`
  - [ ] Test: `normalizeSSN('8503151234')` returns `'850315-1234'`
  - [ ] Test: `normalizeSSN('850315-1234')` returns `'850315-1234'` (already normalized)
  - [ ] Test: `normalizeSSN('19850315-1234')` returns `'850315-1234'` (strips century)
  - [ ] Test: `normalizeSSN('198503151234')` returns `'850315-1234'` (12 digits)
  - [ ] Test: Invalid input `'123'` throws error
  - [ ] Test: Invalid input `'abc123'` throws error
  - [ ] All tests should pass

- [ ] **Create Integration Tests for Employee Service** (AC: 3, 4, 7, 8)
  - [ ] Create or update `tests/integration/api/employees.test.ts`
  - [ ] Test: POST `/api/employees` with dashless SSN `8503151234`
    - [ ] Response includes normalized SSN `850315-1234`
    - [ ] Database stores `850315-1234`
  - [ ] Test: POST `/api/employees` with dashed SSN `850315-1234`
    - [ ] Response includes SSN as-is `850315-1234`
    - [ ] Database stores `850315-1234`
  - [ ] Test: PATCH `/api/employees/:id` with dashless SSN
    - [ ] Response includes normalized SSN
    - [ ] Database updated with normalized format
  - [ ] All tests should pass

- [ ] **Manual Testing Checklist** (AC: 1, 2, 5, 7, 8)
  - [ ] Test Add Employee Modal:
    - [ ] Enter SSN without dash: `8503151234` → Submit
    - [ ] Verify: No validation error, form submits successfully
    - [ ] Verify: Employee table displays `850315-1234` (with dash)
    - [ ] Verify: Database contains `850315-1234`
  - [ ] Test Add Employee Modal:
    - [ ] Enter SSN with dash: `850315-1234` → Submit
    - [ ] Verify: No validation error, form submits successfully
    - [ ] Verify: Employee table displays `850315-1234` (unchanged)
  - [ ] Test Edit Employee:
    - [ ] Edit existing employee, change SSN to `9001011234` (no dash)
    - [ ] Verify: Saves successfully, table displays `900101-1234`
  - [ ] Test CSV Import:
    - [ ] Import CSV with mix of dashed and dashless SSNs
    - [ ] Verify: All SSNs imported successfully
    - [ ] Verify: Database stores all SSNs in normalized format with dash
  - [ ] Test Invalid SSN:
    - [ ] Enter SSN `123` → Verify validation error shown
    - [ ] Enter SSN `abc123` → Verify validation error shown
  - [ ] Test in Swedish Language:
    - [ ] Switch to Swedish locale
    - [ ] Trigger SSN validation error
    - [ ] Verify: Swedish error message displayed

---

## Dev Notes

### Purpose

This story improves data entry UX for HR Admins by accepting Swedish personal numbers (personnummer) in both standard format with dash (`YYMMDD-XXXX`) and without dash (`YYMMDDXXXX`). The system will automatically normalize all SSNs to the standard dashed format for storage and display consistency.

**Source:** Epic 5.5, Story 5.11 - Post-MVP Polish & Branding
**Location:** `docs/prd/epic-5.5-post-mvp-polish-branding.md`

### Previous Story Insights

**From Story 5.10 (Mouseover Tooltips):**

- All UI text must be fully internationalized (English/Swedish)
- Translation files located in `messages/en.json` and `messages/sv.json`
- Use `useTranslations` hook to access translated strings
- Validation error messages must be translatable

**From Story 5.9 (Language Toggle):**

- Default language is Swedish (Swedish users are primary audience)
- All user-facing text must support both Swedish and English
- Translation keys follow camelCase naming convention

### Data Models

**Employee SSN Field:**

- **Type:** `string` (required, unique)
- **Format:** Swedish personal number (personnummer)
- **Storage Format:** `YYMMDD-XXXX` (always with dash)
- **Input Formats Accepted:**
  - `YYMMDD-XXXX` (6 digits + dash + 4 digits)
  - `YYYYMMDD-XXXX` (8 digits + dash + 4 digits - century included)
  - `YYMMDDXXXX` (10 digits, no dash)
  - `YYYYMMDDXXXX` (12 digits, no dash)
- **Validation:** Must be unique across all employees
- **Database Column:** `employees.ssn` (text, unique constraint)

[Source: docs/architecture/data-models.md#employee]

**TypeScript Interface:**

```typescript
export interface Employee {
  id: string;
  ssn: string; // Always stored as YYMMDD-XXXX
  // ... other fields
}
```

[Source: docs/architecture/data-models.md#typescript-interface]

### Current Validation Implementation

**File:** `src/lib/validation/employee-schema.ts`

**Current SSN Regex:**

```typescript
const ssnRegex = /^\d{6,8}-\d{4}$/;
```

This regex ONLY accepts dashed format. Must be updated to accept dashless format as well.

**Current Validation Schema:**

```typescript
ssn: z.string().min(1, msg('ssnRequired')).regex(ssnRegex, msg('ssnFormat'));
```

**Error Message Keys:**

- `errors.validation.ssnRequired` - "SSN is required"
- `errors.validation.ssnFormat` - "SSN must be in format YYYYMMDD-XXXX or YYMMDD-XXXX"

[Source: docs/architecture/data-models.md, src/lib/validation/employee-schema.ts]

### Normalization Logic

**New Utility Function to Create:**
`src/lib/utils/ssn-formatter.ts`

```typescript
/**
 * Normalizes Swedish personal number (personnummer) to standard format YYMMDD-XXXX
 *
 * Accepts:
 * - YYMMDDXXXX (10 digits) → YYMMDD-XXXX
 * - YYYYMMDDXXXX (12 digits) → YYMMDD-XXXX (strips century)
 * - YYMMDD-XXXX (already normalized) → YYMMDD-XXXX
 * - YYYYMMDD-XXXX (with century) → YYMMDD-XXXX (strips century)
 *
 * @param ssn - Swedish personal number in any accepted format
 * @returns Normalized SSN in format YYMMDD-XXXX
 * @throws Error if SSN format is invalid
 *
 * @example
 * normalizeSSN('8503151234') // Returns '850315-1234'
 * normalizeSSN('850315-1234') // Returns '850315-1234'
 * normalizeSSN('19850315-1234') // Returns '850315-1234'
 */
export function normalizeSSN(ssn: string): string {
  // Remove all non-digit characters
  const digitsOnly = ssn.replace(/\D/g, '');

  // Validate length
  if (digitsOnly.length === 10) {
    // YYMMDDXXXX → YYMMDD-XXXX
    return `${digitsOnly.slice(0, 6)}-${digitsOnly.slice(6)}`;
  } else if (digitsOnly.length === 12) {
    // YYYYMMDDXXXX → YYMMDD-XXXX (strip first 2 digits)
    return `${digitsOnly.slice(2, 8)}-${digitsOnly.slice(8)}`;
  } else {
    throw new Error(
      `Invalid SSN length: expected 10 or 12 digits, got ${digitsOnly.length}`
    );
  }
}
```

### File Locations

**Files to Modify:**

1. `src/lib/validation/employee-schema.ts` - Update SSN regex to accept dashless format
2. `src/lib/server/services/employee-service.ts` - Add SSN normalization before database insert/update
3. `messages/en.json` - Update SSN validation error message
4. `messages/sv.json` - Update SSN validation error message (Swedish)

**Files to Create:**

1. `src/lib/utils/ssn-formatter.ts` - New utility module for SSN normalization
2. `tests/unit/utils/ssn-formatter.test.ts` - Unit tests for normalization function

**Files to Review (likely no changes needed):**

- `src/components/dashboard/employee-table.tsx` - Displays SSN from database (already normalized)
- `src/components/dashboard/add-employee-modal.tsx` - Form validation uses updated schema
- `src/components/dashboard/edit-employee-modal.tsx` - Form validation uses updated schema
- `src/app/api/employees/route.ts` - Uses employee service (normalization in service layer)
- `src/app/api/employees/[id]/route.ts` - Uses employee service (normalization in service layer)

[Source: docs/architecture/source-tree.md]

### Validation Flow

**Current Flow:**

1. User enters SSN in form (e.g., Add Employee Modal)
2. Frontend validates SSN format using Zod schema with `ssnRegex`
3. If valid, form submits to API route
4. API route calls `employeeService.create(data)`
5. Service inserts data into database AS-IS (no normalization)

**Updated Flow (Story 5.11):**

1. User enters SSN in form (with OR without dash)
2. Frontend validates SSN format using UPDATED Zod schema (accepts both formats)
3. If valid, form submits to API route
4. API route calls `employeeService.create(data)`
5. **NEW:** Service calls `normalizeSSN(data.ssn)` to convert to standard format
6. Service inserts NORMALIZED SSN into database (`YYMMDD-XXXX`)

### Backend Architecture

**Service Layer Pattern:**

- All business logic lives in `src/lib/server/services/`
- Services call repositories for database access
- API routes are thin wrappers that call services

**Employee Service Location:**
`src/lib/server/services/employee-service.ts`

**Methods to Update:**

1. `createEmployee(data: CreateEmployeeInput)` - Add SSN normalization
2. `updateEmployee(id: string, data: UpdateEmployeeInput)` - Add SSN normalization (if SSN field present)

**Pattern:**

```typescript
import { normalizeSSN } from '@/lib/utils/ssn-formatter';

async createEmployee(data: CreateEmployeeInput) {
  // Normalize SSN before database insert
  const normalizedData = {
    ...data,
    ssn: normalizeSSN(data.ssn)
  };

  // Proceed with database insert
  return await employeeRepository.create(normalizedData);
}
```

[Source: docs/architecture/backend-architecture.md, docs/architecture/coding-standards.md]

### Testing Requirements

**Test File Location:**

- Unit tests: `tests/unit/utils/ssn-formatter.test.ts`
- Integration tests: `tests/integration/api/employees.test.ts` (update existing file)

[Source: docs/architecture/testing-strategy.md]

**Test Framework:**

- **Vitest** for unit and integration tests
- **React Testing Library** for component tests (not needed for this story)

[Source: docs/architecture/tech-stack.md]

**Test Coverage Goals:**

- Overall: 70%+ (project standard)
- Business logic: 90%+ (normalization function is business logic)
- This story: 100% coverage for `normalizeSSN` function

[Source: docs/architecture/testing-strategy.md]

**Key Test Scenarios:**

**Unit Tests (ssn-formatter.test.ts):**

1. Normalize dashless 10-digit SSN: `'8503151234'` → `'850315-1234'`
2. Normalize dashless 12-digit SSN: `'198503151234'` → `'850315-1234'`
3. Already normalized SSN: `'850315-1234'` → `'850315-1234'` (no change)
4. SSN with century and dash: `'19850315-1234'` → `'850315-1234'`
5. Invalid length (9 digits): `'123456789'` → throws error
6. Invalid characters: `'abc123'` → throws error (becomes 6 digits after strip, invalid)
7. Empty string: `''` → throws error

**Integration Tests (employees.test.ts):**

1. POST `/api/employees` with dashless SSN → response contains normalized SSN
2. POST `/api/employees` with dashed SSN → response contains SSN unchanged
3. PATCH `/api/employees/:id` with dashless SSN → database updated with normalized SSN
4. Verify database contains normalized SSN after create/update operations

**Manual Testing:**

- Add employee with dashless SSN via UI → verify table displays dashed format
- Edit employee, change SSN to dashless → verify saves correctly
- Import CSV with mix of dashed and dashless SSNs → verify all normalized
- Trigger validation error → verify Swedish error message when locale is Swedish

[Source: docs/architecture/testing-strategy.md]

### Coding Standards

**Naming Conventions:**

- Utility functions: camelCase (e.g., `normalizeSSN`)
- Utility modules: kebab-case (e.g., `ssn-formatter.ts`)
- Test files: `*.test.ts` suffix

[Source: docs/architecture/coding-standards.md]

**Import Aliases:**
Use `@/` for all imports from `src/`:

```typescript
import { normalizeSSN } from '@/lib/utils/ssn-formatter';
import { employeeService } from '@/lib/services/employee-service';
```

[Source: docs/architecture/coding-standards.md]

**Error Handling:**

- Throw descriptive errors for invalid input
- Use TypeScript strict mode
- Never return `null` or `undefined` for validation functions - throw errors instead

[Source: docs/architecture/coding-standards.md]

**Documentation:**

- Add JSDoc comments to all exported functions
- Include `@param`, `@returns`, `@throws`, and `@example` tags
- Explain WHY the function exists, not just WHAT it does

[Source: docs/architecture/coding-standards.md]

### Translation Keys

**English (`messages/en.json`):**

```json
{
  "errors": {
    "validation": {
      "ssnFormat": "SSN must be in format YYMMDD-XXXX or YYMMDDXXXX (10 digits)"
    }
  }
}
```

**Swedish (`messages/sv.json`):**

```json
{
  "errors": {
    "validation": {
      "ssnFormat": "Personnummer måste vara i format ÅÅMMDD-XXXX eller ÅÅMMDDXXXX (10 siffror)"
    }
  }
}
```

**Translation Access:**

```typescript
import { useTranslations } from 'next-intl';

const tErrors = useTranslations('errors');
const errorMessage = tErrors('validation.ssnFormat');
```

[Source: Story 5.9, Story 5.10, docs/architecture/frontend-architecture.md]

### Edge Cases

1. **SSN with spaces:** `'850315 1234'` → Spaces stripped → normalized to `'850315-1234'`
2. **SSN with multiple dashes:** `'850-315-1234'` → All dashes stripped, digits extracted → normalized
3. **SSN already normalized:** `'850315-1234'` → No change needed, returns as-is
4. **12-digit SSN (century included):** `'198503151234'` → Strip first 2 digits → `'850315-1234'`
5. **Invalid lengths:** 9 digits, 11 digits, 13 digits → Throw error with descriptive message

### Security Considerations

**SSN is Sensitive Data:**

- SSNs are personally identifiable information (PII)
- Must be stored securely in database
- Row-level security (RLS) policies restrict access based on user role
- Never log SSNs in plain text

**No Changes to Security:**

- This story only affects input format and normalization
- Database security (RLS policies) unchanged
- API authentication/authorization unchanged

[Source: docs/architecture/security-and-performance.md]

### Performance Considerations

**Normalization Impact:**

- `normalizeSSN` is a simple string manipulation function
- Runtime: O(n) where n = SSN length (max 14 characters)
- Negligible performance impact (<1ms per call)
- No database queries or API calls involved

**No Performance Concerns:**

- Normalization happens once per employee create/update operation
- Validation happens client-side (instant feedback)
- No additional database queries needed

[Source: docs/architecture/security-and-performance.md]

### Database Schema

**No Schema Changes Required:**

- `employees.ssn` column already exists as `text` type
- Unique constraint already exists on `ssn` column
- No migration needed

**Database Location:**
PostgreSQL (Supabase)

[Source: docs/architecture/database-schema.md]

### Known Limitations

**Out of Scope for Story 5.11:**

- SSN validation logic (checksum validation) - only format validation
- SSN masking for display (e.g., `******-1234`) - privacy feature for future
- Historical SSN formats (different formats used before 1947) - not needed for Stena Line use case
- Support for coordination numbers (samordningsnummer) - different format, separate story if needed

---

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-30 | 1.0     | Initial story creation | Scrum Master (Bob) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by the QA agent after implementation review._
