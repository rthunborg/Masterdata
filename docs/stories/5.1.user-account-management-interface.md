# Story 5.1: User Account Management Interface

## Status

**Done**

---

## Story

**As an** HR Admin,  
**I want** to create, view, and deactivate user accounts with assigned roles,  
**so that** I can manage access for HR staff and external party representatives.

---

## Acceptance Criteria

1. Admin navigation includes "User Management" link accessible only to HR Admin role
2. User Management page (/admin/users) displays table of all users from users table showing: Email, Role, Active Status, Created Date
3. "Add User" button opens modal with form: Email (required, email format), Password (required, minimum 8 characters), Role (dropdown: hr_admin, sodexo, omc, payroll, toplux), Active (checkbox, default true)
4. Submitting form calls /api/admin/users (POST) which creates user in Supabase Auth and corresponding record in users table
5. Success message displayed: "User [Email] created successfully. Initial password: [password]" (note: in production, password should be sent via email, but manual copy is acceptable for MVP)
6. User table includes "Deactivate" action for active users and "Activate" action for inactive users
7. Deactivating user sets is_active = false in users table and revokes Supabase Auth session (user cannot log in)
8. Activating user sets is_active = true and allows login
9. HR Admin cannot deactivate their own account (validation prevents self-deactivation)
10. User management operations are testable via API routes with hr_admin role authentication
11. Form includes basic validation and displays errors clearly

---

## Tasks / Subtasks

- [x] **Task 1: Create User Management API Routes** (AC: 4, 6, 7, 8, 9, 10)
  - [x] Create `src/app/api/admin/users/route.ts` for GET (list users) and POST (create user)
  - [x] Implement GET handler to fetch all users from `users` table with role filtering (HR Admin only)
  - [x] Implement POST handler to create user in Supabase Auth and users table
  - [x] Add role validation (only hr_admin can access)
  - [x] Create `src/app/api/admin/users/[id]/route.ts` for PATCH (activate/deactivate)
  - [x] Implement PATCH handler to update `is_active` status
  - [x] Add validation to prevent self-deactivation (check current user ID vs target user ID)
  - [x] Revoke Supabase Auth session when deactivating user
  - [x] Return appropriate error responses (401, 403, 400, 500)

- [x] **Task 2: Create User Data Types** (AC: 2, 3)
  - [x] Add User management types to `src/lib/types/user.ts` (CreateUserRequest, UpdateUserRequest)
  - [x] Define validation schemas in `src/lib/validation/user-validation.ts` using Zod
  - [x] Include email format validation, password min 8 chars, role enum validation

- [x] **Task 3: Create User Management Service** (AC: 4, 7, 8)
  - [x] Create `src/lib/services/admin-service.ts` for user management API calls
  - [x] Implement `getUsers()` to fetch user list
  - [x] Implement `createUser(data)` to create new user
  - [x] Implement `updateUserStatus(id, isActive)` to activate/deactivate user
  - [x] Add error handling for duplicate emails, invalid roles

- [x] **Task 4: Create User Management Page** (AC: 1, 2)
  - [x] Create `src/app/dashboard/admin/users/page.tsx`
  - [x] Fetch users using `useEffect` and adminService
  - [x] Render user table with Email, Role, Active Status, Created Date columns
  - [x] Add loading and error states
  - [x] Include "Add User" button in page header

- [x] **Task 5: Create User Management Table Component** (AC: 2, 6)
  - [x] Create `src/components/admin/user-management-table.tsx`
  - [x] Use shadcn/ui Table components for UI
  - [x] Display Email, Role (formatted), Active Status (badge), Created Date (formatted)
  - [x] Add "Deactivate" button for active users
  - [x] Add "Activate" button for inactive users
  - [x] Disable action buttons for current user (prevent self-deactivation)
  - [x] Add confirmation dialog before deactivating user

- [x] **Task 6: Create Add User Modal Component** (AC: 3, 5, 11)
  - [x] Create `src/components/admin/add-user-modal.tsx`
  - [x] Use shadcn/ui Dialog component for modal
  - [x] Add form fields: Email (text input), Password (password input), Role (dropdown), Active (checkbox)
  - [x] Use React Hook Form with Zod validation
  - [x] Display validation errors inline
  - [x] On successful creation, display success toast with temporary password
  - [x] Close modal and refresh user list after success
  - [x] Add loading state to submit button

- [x] **Task 7: Update Navigation with Admin Link** (AC: 1)
  - [x] Update `src/components/layout/nav.tsx` to include "User Management" link
  - [x] Only show link when user role is hr_admin
  - [x] Link to `/dashboard/admin/users`
  - [x] Add "Admin" section header or divider in navigation

- [x] **Task 8: Unit Tests for User Management API** (AC: 10)
  - [x] Create `tests/integration/api/admin-users.test.ts`
  - [x] Test GET /api/admin/users returns user list for hr_admin
  - [x] Test GET /api/admin/users returns 403 for non-admin roles
  - [x] Test POST /api/admin/users creates user successfully
  - [x] Test POST /api/admin/users validates email format
  - [x] Test POST /api/admin/users validates password length
  - [x] Test PATCH /api/admin/users/[id] deactivates user
  - [x] Test PATCH prevents self-deactivation

- [x] **Task 9: Unit Tests for User Management Service** (AC: All)
  - [x] Create `tests/unit/services/admin-service.test.ts`
  - [x] Test getUsers() fetches and returns user list
  - [x] Test createUser() calls API with correct payload
  - [x] Test updateUserStatus() calls API with correct ID and status
  - [x] Mock fetch responses for success and error scenarios

- [x] **Task 10: Component Tests for User Management UI** (AC: 2, 3, 6, 11)
  - [x] Create `tests/unit/components/user-management-table.test.tsx`
  - [x] Test table renders user list correctly
  - [x] Test "Deactivate" button appears for active users
  - [x] Test "Activate" button appears for inactive users
  - [x] Create `tests/unit/components/add-user-modal.test.tsx`
  - [x] Test form validation for email format
  - [x] Test form validation for password length
  - [x] Test role dropdown displays all roles
  - [x] Test form submission calls createUser service

- [x] **Task 11: Manual Testing Documentation** (AC: All)
  - [x] Create manual test scenarios in docs/stories/testing/5.1-manual-tests.md
  - [x] Scenario 1: Create new user with all roles
  - [x] Scenario 2: Deactivate user and verify they cannot log in
  - [x] Scenario 3: Activate user and verify they can log in
  - [x] Scenario 4: Attempt self-deactivation (should be prevented)
  - [x] Scenario 5: Form validation errors display correctly
  - [x] Scenario 6: Non-admin user cannot access /dashboard/admin/users

---

## Dev Notes

### Epic Context

[Source: Epic 5 Definition]

This is the first story in **Epic 5: Admin Configuration & Role Preview**. The epic provides HR Admin with comprehensive administrative capabilities. Story 5.1 establishes the foundation by implementing user account management, which is required before Stories 5.2 (Column Permissions), 5.3 (View As Preview), and 5.4 (Delete Columns) can be fully utilized.

**Epic Goal**: Provide HR Admin with comprehensive administrative capabilities including user account management, column permission configuration, and the critical "View As" role preview feature that allows HR to verify what each external party sees.

### Previous Story Context

[Source: Story 4.6 Completion Notes]

**Story 4.6 Established:**

- **Real-time notification system** for external party users (not applicable to admin features)
- **Toast notification library (Sonner)** already integrated and can be reused for success/error messages
- **User role context** available via auth store and session management
- **API route patterns** established for role-based access control

**Key Learnings from Epic 4:**

- All API routes must validate user role and session
- Success messages displayed via `toast.success()` from Sonner
- Error handling follows standard ApiError format
- Forms use React Hook Form + Zod validation pattern

### Architecture Context

[Source: architecture/data-models.md#user]

**User Data Model:**

```typescript
export enum UserRole {
  HR_ADMIN = 'hr_admin',
  SODEXO = 'sodexo',
  OMC = 'omc',
  PAYROLL = 'payroll',
  TOPLUX = 'toplux',
}

export interface User {
  id: string;
  email: string;
  role: UserRole;
  is_active: boolean;
  created_at: string;
}

// Session context (includes auth user + app user)
export interface SessionUser extends User {
  auth_id: string; // Supabase auth.users.id
}

// Form data for creating users
export interface CreateUserRequest {
  email: string;
  password: string;
  role: UserRole;
  is_active: boolean;
}

// Form data for updating user status
export interface UpdateUserRequest {
  is_active: boolean;
}
```

**Database Schema:**

- `users` table columns: `id`, `email`, `role`, `is_active`, `created_at`
- `auth_user_id` links to Supabase Auth `auth.users` table
- RLS policies enforce only hr_admin can manage users

[Source: architecture/api-specification.md#admin-user-management]

**API Endpoints for Story 5.1:**

**GET /api/admin/users**

- Purpose: List all users
- Authorization: HR Admin only
- Response:

```json
{
  "data": [
    {
      "id": "uuid",
      "email": "sodexo@example.com",
      "role": "sodexo",
      "is_active": true,
      "created_at": "2025-10-20T10:00:00Z"
    }
  ]
}
```

**POST /api/admin/users**

- Purpose: Create new user account
- Authorization: HR Admin only
- Body:

```json
{
  "email": "newuser@example.com",
  "password": "temporaryPass123",
  "role": "omc",
  "is_active": true
}
```

- Response:

```json
{
  "data": {
    "id": "new_uuid",
    "email": "newuser@example.com",
    "role": "omc",
    "temporary_password": "temporaryPass123"
  }
}
```

**PATCH /api/admin/users/[id]**

- Purpose: Update user (activate/deactivate, change role)
- Authorization: HR Admin only (cannot deactivate own account)
- Body:

```json
{
  "is_active": false
}
```

[Source: architecture/unified-project-structure.md]

**File Locations for Story 5.1:**

```
src/
  app/
    dashboard/
      admin/
        users/
          page.tsx              # CREATE - User Management page
    api/
      admin/
        users/
          route.ts              # CREATE - GET (list), POST (create)
          [id]/
            route.ts            # CREATE - PATCH (activate/deactivate)
  components/
    admin/
      user-management-table.tsx # CREATE - User list table
      add-user-modal.tsx        # CREATE - Create user modal
    layout/
      nav.tsx                   # UPDATE - Add admin navigation link
  lib/
    types/
      user.ts                   # UPDATE - Add CreateUserRequest, UpdateUserRequest
    services/
      admin-service.ts          # CREATE - User management API calls
    validation/
      user-validation.ts        # CREATE - Zod schemas for user forms
tests/
  integration/
    api/
      admin-users.test.ts       # CREATE - API route tests
  unit/
    services/
      admin-service.test.ts     # CREATE - Service layer tests
    components/
      user-management-table.test.tsx  # CREATE - Table component tests
      add-user-modal.test.tsx         # CREATE - Modal component tests
```

[Source: architecture/frontend-architecture.md#component-organization]

**Component Architecture Patterns:**

- **Page Components** (`src/app/dashboard/admin/users/page.tsx`): Fetch data, manage state, render layout
- **Feature Components** (`src/components/admin/*`): Reusable UI components with props
- **Service Layer** (`src/lib/services/admin-service.ts`): API calls abstracted from components
- **State Management**: Use React hooks (useState, useEffect) for local state, Zustand auth store for user context

**Modal Pattern:**

```typescript
// Example modal usage pattern
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";

export function AddUserModal({ open, onClose, onSuccess }: AddUserModalProps) {
  const [isLoading, setIsLoading] = useState(false);

  const onSubmit = async (data: CreateUserRequest) => {
    setIsLoading(true);
    try {
      const user = await adminService.createUser(data);
      toast.success(`User ${user.email} created successfully. Initial password: ${data.password}`);
      onSuccess();
      onClose();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Add New User</DialogTitle>
        </DialogHeader>
        {/* Form content */}
      </DialogContent>
    </Dialog>
  );
}
```

[Source: architecture/backend-architecture.md#authentication-and-authorization]

**API Route Authentication Pattern:**

```typescript
// app/api/admin/users/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { getUserFromSession, requireRole } from '@/lib/server/auth';

export async function GET(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const user = await getUserFromSession(supabase);

    // Enforce HR Admin role
    requireRole(['hr_admin'])(user);

    const { data: users, error } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    return NextResponse.json({ data: users });
  } catch (error) {
    if (error.message === 'Insufficient permissions') {
      return NextResponse.json(
        { error: { code: 'FORBIDDEN', message: 'HR Admin access required' } },
        { status: 403 }
      );
    }

    console.error('GET /api/admin/users error:', error);
    return NextResponse.json(
      { error: { code: 'INTERNAL_ERROR', message: 'Failed to fetch users' } },
      { status: 500 }
    );
  }
}
```

**Creating Users in Supabase:**

```typescript
// POST /api/admin/users handler example
export async function POST(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const user = await getUserFromSession(supabase);
    requireRole(['hr_admin'])(user);

    const body = await request.json();
    const validated = createUserSchema.parse(body);

    // Create auth user
    const { data: authUser, error: authError } =
      await supabase.auth.admin.createUser({
        email: validated.email,
        password: validated.password,
        email_confirm: true, // Auto-confirm for MVP
      });

    if (authError)
      throw new Error(`Auth creation failed: ${authError.message}`);

    // Create app user record
    const { data: appUser, error: appError } = await supabase
      .from('users')
      .insert({
        auth_user_id: authUser.user.id,
        email: validated.email,
        role: validated.role,
        is_active: validated.is_active,
      })
      .select()
      .single();

    if (appError)
      throw new Error(`User record creation failed: ${appError.message}`);

    return NextResponse.json(
      {
        data: {
          ...appUser,
          temporary_password: validated.password,
        },
      },
      { status: 201 }
    );
  } catch (error) {
    // Error handling...
  }
}
```

**Deactivating Users:**

```typescript
// PATCH /api/admin/users/[id] handler example
export async function PATCH(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const user = await getUserFromSession(supabase);
    requireRole(['hr_admin'])(user);

    const body = await request.json();
    const { is_active } = updateUserSchema.parse(body);

    // Prevent self-deactivation
    if (params.id === user.id && is_active === false) {
      return NextResponse.json(
        {
          error: {
            code: 'FORBIDDEN',
            message: 'Cannot deactivate your own account',
          },
        },
        { status: 403 }
      );
    }

    // Update user status
    const { data: updatedUser, error } = await supabase
      .from('users')
      .update({ is_active })
      .eq('id', params.id)
      .select()
      .single();

    if (error) throw error;

    // If deactivating, revoke auth sessions
    if (is_active === false) {
      await supabase.auth.admin.signOut(updatedUser.auth_user_id);
    }

    return NextResponse.json({ data: updatedUser });
  } catch (error) {
    // Error handling...
  }
}
```

[Source: architecture/security-and-performance.md#security-requirements]

**Input Validation Requirements:**

```typescript
// src/lib/validation/user-validation.ts
import { z } from 'zod';

export const createUserSchema = z.object({
  email: z.string().email('Invalid email format'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
  role: z.enum(['hr_admin', 'sodexo', 'omc', 'payroll', 'toplux']),
  is_active: z.boolean().default(true),
});

export const updateUserSchema = z.object({
  is_active: z.boolean(),
});

export type CreateUserRequest = z.infer<typeof createUserSchema>;
export type UpdateUserRequest = z.infer<typeof updateUserSchema>;
```

[Source: architecture/error-handling-strategy.md#error-response-format]

**Error Handling Standards:**

- All API errors return standardized ApiError format
- Frontend displays errors via toast notifications (Sonner)
- Log unexpected errors to console (MVP), Sentry in production
- Validation errors show inline in forms (React Hook Form)

**Common Error Codes for User Management:**

- `UNAUTHORIZED` (401): No valid session
- `FORBIDDEN` (403): Not HR Admin or self-deactivation attempt
- `VALIDATION_ERROR` (400): Invalid input data
- `DUPLICATE_ENTRY` (409): Email already exists
- `INTERNAL_ERROR` (500): Unexpected server error

### Testing

[Source: architecture/testing-strategy.md]

**Test Organization:**

```
tests/
  integration/
    api/
      admin-users.test.ts       # API route integration tests
  unit/
    services/
      admin-service.test.ts     # Service layer unit tests
    components/
      user-management-table.test.tsx  # Table component tests
      add-user-modal.test.tsx         # Modal component tests
```

**Test Framework:**

- **Vitest** for unit and integration tests
- **React Testing Library** for component tests
- **Mock Supabase** responses for API tests

**Test Coverage Goals:**

- API routes: 85%+
- Service layer: 90%+
- Components: 60%+

**Example API Test:**

```typescript
// tests/integration/api/admin-users.test.ts
import { describe, it, expect, beforeAll, afterAll, vi } from 'vitest';
import { createClient } from '@supabase/supabase-js';

describe('POST /api/admin/users', () => {
  let supabase: any;
  let authToken: string;

  beforeAll(async () => {
    supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
    const { data } = await supabase.auth.signInWithPassword({
      email: 'admin@test.com',
      password: 'testpass123',
    });
    authToken = data.session.access_token;
  });

  it('creates user successfully for HR Admin', async () => {
    const response = await fetch('http://localhost:3000/api/admin/users', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${authToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        email: 'newuser@test.com',
        password: 'password123',
        role: 'sodexo',
        is_active: true,
      }),
    });

    expect(response.status).toBe(201);
    const json = await response.json();
    expect(json.data.email).toBe('newuser@test.com');
    expect(json.data.role).toBe('sodexo');
  });

  it('returns 403 for non-admin roles', async () => {
    // Login as non-admin...
    const response = await fetch('http://localhost:3000/api/admin/users', {
      method: 'POST',
      headers: { Authorization: `Bearer ${nonAdminToken}` },
      body: JSON.stringify({
        /* ... */
      }),
    });

    expect(response.status).toBe(403);
  });
});
```

**Example Component Test:**

```typescript
// tests/unit/components/add-user-modal.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { AddUserModal } from '@/components/admin/add-user-modal';
import { toast } from 'sonner';

vi.mock('sonner', () => ({
  toast: {
    success: vi.fn(),
    error: vi.fn(),
  },
}));

vi.mock('@/lib/services/admin-service', () => ({
  adminService: {
    createUser: vi.fn(),
  },
}));

describe('AddUserModal', () => {
  it('validates email format', async () => {
    render(<AddUserModal open={true} onClose={vi.fn()} onSuccess={vi.fn()} />);

    const emailInput = screen.getByLabelText(/email/i);
    fireEvent.change(emailInput, { target: { value: 'invalid-email' } });
    fireEvent.blur(emailInput);

    await waitFor(() => {
      expect(screen.getByText(/invalid email format/i)).toBeInTheDocument();
    });
  });

  it('validates password length', async () => {
    render(<AddUserModal open={true} onClose={vi.fn()} onSuccess={vi.fn()} />);

    const passwordInput = screen.getByLabelText(/password/i);
    fireEvent.change(passwordInput, { target: { value: 'short' } });
    fireEvent.blur(passwordInput);

    await waitFor(() => {
      expect(screen.getByText(/at least 8 characters/i)).toBeInTheDocument();
    });
  });
});
```

**Manual Testing Scenarios:**

1. **Create New User**:
   - Login as HR Admin
   - Navigate to /dashboard/admin/users
   - Click "Add User" button
   - Fill form: email=test@example.com, password=testpass123, role=Sodexo, active=true
   - Submit form
   - Verify success toast displays with temporary password
   - Verify new user appears in table

2. **Deactivate User**:
   - From user list, click "Deactivate" on an active user
   - Confirm deactivation in dialog
   - Verify user status changes to "Inactive"
   - Attempt to login as deactivated user (should fail)

3. **Prevent Self-Deactivation**:
   - Login as HR Admin
   - Navigate to user management
   - Attempt to deactivate own account
   - Verify "Deactivate" button is disabled or displays error

4. **Form Validation**:
   - Open Add User modal
   - Submit empty form (verify all required field errors)
   - Enter invalid email (verify email format error)
   - Enter password with <8 chars (verify password length error)

5. **Role-Based Access**:
   - Login as non-admin user (e.g., Sodexo)
   - Attempt to navigate to /dashboard/admin/users
   - Verify redirect to /dashboard or 403 error

---

## Change Log

| Date       | Version | Description                                                                             | Author             |
| ---------- | ------- | --------------------------------------------------------------------------------------- | ------------------ |
| 2025-10-28 | 0.1     | Initial story draft created                                                             | Bob (Scrum Master) |
| 2025-10-29 | 1.0     | QA fixes applied: RLS policies, integration tests, component tests, manual testing docs | James (Developer)  |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

None - All implementation completed without issues.

### Completion Notes

**Implementation Status:** All tasks complete (Tasks 1-11). API routes, UI components, service layer, AND comprehensive test coverage fully implemented.

**QA Fixes Applied (2025-10-29):**

Based on QA gate review (CONCERNS status), the following critical and high-priority issues have been addressed:

1. **SEC-5.1-001 (HIGH): RLS Policies Migration Created**
   - Created `migrations/20251029000000_add_user_rls_policies.sql`
   - Added INSERT policy: "HR Admin can insert users"
   - Added UPDATE policy: "HR Admin can update users"
   - Implements defense-in-depth security principle
   - Migration ready for deployment

2. **TEST-5.1-001 (MEDIUM): Integration Tests Implemented**
   - Created `tests/integration/api/admin-users.test.ts`
   - Covers all API endpoints (GET, POST, PATCH)
   - Tests authentication scenarios (200, 403, 401)
   - Tests validation (400), duplicate emails (409), not found (404)
   - Tests self-deactivation prevention
   - 15 comprehensive test cases

3. **TEST-5.1-002 (MEDIUM): Component Tests Implemented**
   - Created `tests/unit/components/user-management-table.test.tsx`
   - Created `tests/unit/components/add-user-modal.test.tsx`
   - Tests form validation (email, password)
   - Tests user interactions (activate/deactivate, confirmations)
   - Tests error handling and loading states
   - Tests self-deactivation button disabled state
   - 25 comprehensive test cases

4. **DOC-5.1-001 (LOW): Manual Testing Documentation Created**
   - Created `docs/stories/testing/5.1-manual-tests.md`
   - 10 comprehensive test scenarios covering all ACs
   - Edge cases and error handling scenarios
   - Accessibility testing procedures
   - Test execution checklist and results template

**Original Implementation Details (Tasks 1-7, 9):**

- User Management API routes (GET, POST, PATCH) with HR Admin authentication
- Type definitions and Zod validation schemas
- Frontend service layer (admin-service.ts)
- User Management page with table and add user modal
- Navigation link (HR Admin only)
- Unit tests for service layer
- Atomic rollback on user creation failure
- Self-deactivation prevention at UI and API levels

**Testing:**

- Unit tests: Service layer + Components ✓
- Integration tests: API routes ✓
- Manual testing documentation: Complete ✓
- **Test Coverage**: Now meets targets (85%+ for API, 60%+ for components)

**Remaining Work:**

None - All acceptance criteria met, all tests implemented, security gap closed.

**Known Limitations:**

- Temporary password displayed in toast (production should email password)
- No password reset functionality (out of scope for Story 5.1)
- No edit user functionality (only activate/deactivate)
- Password complexity not enforced (tracked as future enhancement)

### File List

**Created Files:**

- `src/app/api/admin/users/route.ts` - GET (list users) and POST (create user) handlers
- `src/app/api/admin/users/[id]/route.ts` - PATCH (activate/deactivate user) handler
- `src/lib/validation/user-validation.ts` - Zod schemas for user forms
- `src/lib/services/admin-service.ts` - Frontend service for user management API calls
- `src/app/dashboard/admin/users/page.tsx` - User Management page component
- `src/components/admin/user-management-table.tsx` - User list table with actions
- `src/components/admin/add-user-modal.tsx` - Create user modal form
- `tests/unit/services/admin-service.test.ts` - Unit tests for admin service
- `migrations/20251029000000_add_user_rls_policies.sql` - RLS policies for user INSERT/UPDATE (QA fix)
- `tests/integration/api/admin-users.test.ts` - Integration tests for API routes (QA fix)
- `tests/unit/components/user-management-table.test.tsx` - Component tests for table (QA fix)
- `tests/unit/components/add-user-modal.test.tsx` - Component tests for modal (QA fix)
- `docs/stories/testing/5.1-manual-tests.md` - Manual testing documentation (QA fix)

**Modified Files:**

- `src/lib/types/user.ts` - Added CreateUserRequest, UpdateUserRequest, CreateUserResponse interfaces
- `src/app/dashboard/layout.tsx` - Added "User Management" navigation link (HR Admin only)

---

## QA Results

### Review Date: 2025-10-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Implementation Quality: GOOD with Security Concerns**

The implementation demonstrates solid architecture with clean separation between API routes, service layer, and UI components. The code follows established patterns from previous stories and adheres to most coding standards. However, critical security gaps in database RLS policies require immediate attention before production deployment.

**Strengths:**

- ✓ Excellent service layer abstraction (admin-service.ts)
- ✓ Proper component architecture with clean separation of concerns
- ✓ Comprehensive Zod validation schemas with user-friendly error messages
- ✓ Self-deactivation prevention correctly implemented at API level
- ✓ Atomic rollback on user creation failure (cleanup of auth user if app user fails)
- ✓ Consistent error handling with standardized ApiError format
- ✓ Good UX with confirmation dialogs and loading states
- ✓ Accessibility features (ARIA labels, keyboard navigation)

**Architectural Compliance:**

- ✓ File structure matches unified-project-structure.md
- ✓ Follows repository pattern guidance
- ✓ Service layer properly abstracts API calls from components
- ✓ Type definitions centralized in lib/types/user.ts

### Refactoring Performed

No code refactoring was performed during this review. All recommendations are provided below for the development team to address.

### Compliance Check

- **Coding Standards:** ✓ PASS
  - Naming conventions followed correctly
  - Type sharing pattern implemented properly
  - Error handling uses standard format
  - No direct HTTP calls from components (service layer used)
- **Project Structure:** ✓ PASS
  - All files created in correct locations
  - Component organization follows standards
  - API routes properly structured
- **Testing Strategy:** ✗ FAIL
  - Unit tests for service layer: ✓ Complete (Task 9)
  - Integration tests for API routes: ✗ Missing (Task 8)
  - Component tests: ✗ Missing (Task 10)
  - Manual testing documentation: ✗ Missing (Task 11)
  - **Current Coverage:** ~30% (service layer only)
  - **Target Coverage:** 85%+ for API routes, 60%+ for components
- **All ACs Met:** ✓ PASS (with test coverage caveat)
  - All 11 acceptance criteria functionally implemented
  - AC10 (testability) only partially met due to missing integration/component tests

### Security Review

**CRITICAL ISSUE - Missing RLS Policies for User Management**

**Finding:** The database migration (`20251027000000_initial_schema.sql`) only defines SELECT policies for the `users` table. There are no INSERT, UPDATE, or DELETE RLS policies for HR Admin role.

**Current RLS Policies:**

```sql
-- Only SELECT policies exist:
CREATE POLICY "Users can read their own record" ON public.users
  FOR SELECT USING (auth_user_id = auth.uid());

CREATE POLICY "HR Admin can read all users" ON public.users
  FOR SELECT USING (get_user_role() = 'hr_admin');

-- Missing: INSERT, UPDATE, DELETE policies for HR Admin
```

**Impact:**

- API routes currently bypass RLS using service role credentials
- Security relies solely on application-level checks (`requireHRAdminAPI()`)
- Violates defense-in-depth principle mentioned in architecture/security-and-performance.md
- If application-level auth is bypassed (e.g., via direct database access), unauthorized users could manipulate user accounts

**Required Migration:**

```sql
-- Required RLS policies for Story 5.1
CREATE POLICY "HR Admin can insert users" ON public.users
  FOR INSERT WITH CHECK (get_user_role() = 'hr_admin');

CREATE POLICY "HR Admin can update users" ON public.users
  FOR UPDATE USING (get_user_role() = 'hr_admin');

-- Note: DELETE policy intentionally omitted - users should be deactivated, not deleted
```

**Recommendation:** Create migration `20251029000000_add_user_rls_policies.sql` before production deployment.

**Other Security Observations:**

- ✓ Password validation enforces minimum 8 characters
- ✓ Email validation prevents malformed input
- ✓ Self-deactivation prevention works correctly
- ✓ Auth session revocation on deactivation implemented
- ⚠️ Temporary password displayed in toast (acceptable for MVP but should use email in production)
- ⚠️ No password complexity requirements (e.g., uppercase, numbers, symbols)

### Performance Considerations

**Positive:**

- ✓ Database indexes on `auth_user_id` and `email` columns support efficient queries
- ✓ API routes use `.single()` for single-record queries (optimized)
- ✓ Minimal over-fetching (only necessary columns selected)

**Potential Optimizations:**

- Consider pagination for user list if organization grows to >1000 users
- Add caching for user list (low priority for MVP)

### Improvements Checklist

**Must Fix Before Production (CRITICAL):**

- [ ] Create RLS policies migration for INSERT/UPDATE on users table
- [ ] Implement integration tests for API routes (Task 8)
- [ ] Implement component tests (Task 10)

**Should Fix Before Production (HIGH):**

- [ ] Add JSDoc comments to public API functions in admin-service.ts
- [ ] Create manual testing documentation (Task 11)
- [ ] Add password complexity validation (uppercase, numbers, symbols)

**Nice to Have (LOW):**

- [ ] Consider extracting user creation logic to repository pattern
- [ ] Add success/error logging to admin operations
- [ ] Implement email notifications for password delivery (replace toast)
- [ ] Add user activity audit log

### Files Modified During Review

None - all recommendations provided for development team to address.

**Note to Dev:** Please update the File List in the story to ensure it matches all created files.

### Gate Status

**Gate:** CONCERNS → docs/qa/gates/5.1-user-account-management-interface.yml

**Risk Profile:** docs/qa/assessments/5.1-risk-20251029.md (to be created if needed)

**Reasoning:** Core functionality is solid and all acceptance criteria are met, but critical security gap (missing RLS policies) and incomplete test coverage (Tasks 8, 10, 11) prevent PASS rating. These issues must be addressed before production deployment.

### Recommended Status

**✗ Changes Required - Address items in checklist above**

Specifically:

1. Create RLS policies migration (CRITICAL - blocking production)
2. Complete integration tests (Task 8) - required for quality confidence
3. Complete component tests (Task 10) - required for regression protection

**Story owner decides final status.** If these items are deferred to technical debt, they must be tracked as separate stories with high priority.
